BetaJS.Templates.Cached=BetaJS.Templates.Cached||{},BetaJS.Templates.Cached["preview-template"]='  <iframe class="preview-iframe">    </iframe>  <div class="preview-overlay" style="display:none">  </div> ',BetaJS.Templates.Cached["simple-code-mirror-view-template"]='  <div class="simple-code-mirror-main">   <textarea></textarea>  </div> ',BetaJS.Views.View.extend("BetaJS.Views.SimpleCodeMirrorView",{_templates:{"default":BetaJS.Templates.Cached["simple-code-mirror-view-template"]},constructor:function(a){this._inherited(BetaJS.Views.SimpleCodeMirrorView,"constructor",a),this._setOptionProperty(a,"content",""),this._setOption(a,"language",""),this._setOptionProperty(a,"readonly",!1),this.on("change:readonly",function(a){this.__code_mirror.setOption("readOnly",a),a?this.$(".cm-s-default").addClass("simple-code-mirror-readonly"):this.$(".cm-s-default").removeClass("simple-code-mirror-readonly")},this),this.on("show",function(){this.isActive()&&this.__code_mirror&&this.__code_mirror.setSize("100%","100%")},this)},_render:function(){this._inherited(BetaJS.Views.SimpleCodeMirrorView,"_render"),this.__initializeCodeMirror()},__initializeCodeMirror:function(){function a(a,b){a.foldCode(b,c.__getRangeFinder())}var b=this.$("textarea").get(0),c=this;this.__code_mirror=CodeMirror(function(a){b.parentNode.replaceChild(a,b)},{value:this.get("content"),mode:this.__getMode(),tabMode:"indent",readOnly:this.get("readonly"),highlightSelectionMatches:!0,autoCloseBrackets:!0,autoCloseTags:!0,lineNumbers:!0,extraKeys:{"Ctrl-Q":function(b){a(b,b.getCursor())},"Ctrl-Space":"__autoComplete"},foldGutter:!0,gutters:[this.__getGutters(),"CodeMirror-linenumbers","CodeMirror-foldgutter"],lintWith:this.__getLintWith()}),this.__code_mirror.on("gutterClick",a),this.__code_mirror.setSize("100%","100%"),this.__suppress_update=!1,this.__code_mirror.on("change",function(){c.__suppress_update=!0,c.set("content",c.__code_mirror.getValue()),c.__suppress_update=!1}),this.on("change:content",function(a){this.__suppress_update||this.__code_mirror.setValue(a)},this)},__getMode:function(){return"html"==this.__language?"text/html":"php"==this.__language?"application/x-httpd-php":this.__language},__autoComplete:function(){"html"==this.__language?CodeMirror.commands.autocomplete=function(a){CodeMirror.showHint(a,CodeMirror.htmlHint)}:"javascript"==this.__language&&(CodeMirror.commands.autocomplete=function(a){CodeMirror.showHint(a,CodeMirror.javascriptHint)})},__getRangeFinder:function(){return"html"==this.__language?CodeMirror.tagRangeFinder:CodeMirror.braceRangeFinder},__getGutters:function(){return"javascript"==this.__language?"CodeMirror-lint-markers":null},__getLintWith:function(){return"javascript"==this.__language?CodeMirror.javascriptValidator:null},__content:function(){return this.__code_mirror.getValue()},formatContent:function(){var a=this.__code_mirror.lineCount()-1;this.__code_mirror.autoFormatRange({line:0,ch:0},{line:a,ch:null}),this.__code_mirror.setSelection({line:0,ch:0})}}),BetaJS.Views.ListContainerView.extend("BetaJS.Views.CodeMirrorView",{constructor:function(a){a=a||{},a.alignment="vertical",a.positioning="computed",this._inherited(BetaJS.Views.CodeMirrorView,"constructor",a),this.toggle_bar_view=this.addChild(new BetaJS.Views.ListContainerView({el_classes:"code-mirror-header",visible:!1})),this._setOptionProperty(a,"readonly",!1),this._setOptionProperty(a,"content","");var b=a.language||"";this.addChild(new BetaJS.Views.View({html:'<span class="code-mirror-window-label">'+b+"</span>"}),{type:"ignore"}),this.code_mirror_view=this.addChild(new BetaJS.Views.SimpleCodeMirrorView({content:this.binding("content"),language:b,readonly:this.binding("readonly"),el_classes:"simple-code-mirror-main"}),{type:"dynamic"})},formatContent:function(){this.code_mirror_view.formatContent()}}),BetaJS.Views.View.extend("BetaJS.Views.PreviewView",{_templates:{"default":BetaJS.Templates.Cached["preview-template"]},update:function(a,b,c,d,e){this.invalidate();var f=this,g=this.$("iframe"),h=window.setInterval(function(){var i=g.get(0).contentDocument||g.get(0).contentWindow.document;if("complete"==i.readyState){window.clearInterval(h),f.trigger("attached",g.get(0));var j=g.contents().find("head"),k=j[0],l=g.contents().find("body"),m=l[0],n=0;BetaJS.Objs.iter(d||[],function(a){var b=document.createElement("script");b.src=a,n++,b.onload=function(){n--,o()},k.appendChild(b)}),BetaJS.Objs.iter(e||[],function(a){var b=document.createElement("link");b.href=a,b.rel="stylesheet",k.appendChild(b)}),l.html(a),l.append("<style>"+c+"</style>");var o=function(){if(0===n){var a=document.createElement("script");a.text=b,m.appendChild(a)}};o()}},10)},iframeWindow:function(){return this.$("iframe").get(0).contentWindow},_bindParent:function(){this.getParent().on("dragstart",this.show_overlay,this).on("dragstop",this.hide_overlay,this)},hide_overlay:function(){this.$(".preview-overlay").css("display","none")},show_overlay:function(){this.$(".preview-overlay").css("display","")}});